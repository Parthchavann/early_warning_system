<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Alert Simulation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .alert { 
            background: #fee; 
            border: 1px solid #fcc; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .critical { background: #ffe6e6; border-color: #ff9999; }
        .high { background: #fff3e6; border-color: #ffcc99; }
        .loading { color: #666; font-style: italic; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>üß™ Dashboard Alert Simulation Test</h1>
    <p>This simulates what the Dashboard component should receive from AlertContext.</p>
    
    <div id="status">Loading alerts...</div>
    <div id="alerts-container"></div>
    
    <script>
        async function testAlertFetch() {
            const statusDiv = document.getElementById('status');
            const alertsContainer = document.getElementById('alerts-container');
            
            try {
                statusDiv.innerHTML = '<span class="loading">üîÑ Fetching alerts from backend...</span>';
                
                // Simulate the exact API call that AlertContext makes
                const response = await fetch('http://localhost:8080/alerts/active', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Raw API response:', data);
                
                // Process alerts like AlertContext does
                let alertsData = [];
                if (data && data.alerts && Array.isArray(data.alerts)) {
                    alertsData = data.alerts.map(alert => ({
                        ...alert,
                        id: alert.alert_id || alert.id,
                        is_acknowledged: alert.is_acknowledged || alert.acknowledged || false
                    }));
                }
                
                // Filter like AlertContext
                const activeAlerts = alertsData.filter(alert => !alert.is_acknowledged);
                const criticalAlerts = alertsData.filter(alert => 
                    alert.severity === 'critical' || (alert.risk_score && alert.risk_score >= 0.8)
                );
                
                console.log('Processed alerts:', alertsData);
                console.log('Active alerts:', activeAlerts);
                console.log('Critical alerts:', criticalAlerts);
                
                // Display results
                statusDiv.innerHTML = `
                    <span class="success">‚úÖ Success!</span> 
                    Total: ${alertsData.length}, 
                    Active: ${activeAlerts.length}, 
                    Critical: ${criticalAlerts.length}
                `;
                
                if (activeAlerts.length > 0) {
                    alertsContainer.innerHTML = '<h3>üö® Active Alerts (What Dashboard Should Show):</h3>';
                    
                    activeAlerts.forEach((alert, index) => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert ${alert.severity}`;
                        alertDiv.innerHTML = `
                            <strong>Alert ${index + 1}: ${alert.patient_name || 'Unknown Patient'}</strong><br>
                            <strong>Severity:</strong> ${alert.severity}<br>
                            <strong>Risk Score:</strong> ${alert.risk_score}<br>
                            <strong>Message:</strong> ${alert.message}<br>
                            <strong>Patient ID:</strong> ${alert.patient_id}<br>
                            <strong>Alert ID:</strong> ${alert.id}<br>
                            <strong>Timestamp:</strong> ${alert.timestamp}
                        `;
                        alertsContainer.appendChild(alertDiv);
                    });
                } else {
                    alertsContainer.innerHTML = '<h3>‚ÑπÔ∏è No active alerts found</h3>';
                }
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                alertsContainer.innerHTML = `
                    <h3>üîß Troubleshooting:</h3>
                    <ul>
                        <li>Make sure backend server is running on localhost:8080</li>
                        <li>Check browser console for CORS errors</li>
                        <li>Verify CORS headers allow localhost:3000</li>
                    </ul>
                `;
            }
        }
        
        // Run test when page loads
        window.addEventListener('load', testAlertFetch);
    </script>
</body>
</html>